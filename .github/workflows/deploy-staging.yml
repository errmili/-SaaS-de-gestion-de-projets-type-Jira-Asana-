# ==========================================
# Pipeline CD - DÃ©ploiement Staging SIMPLE
# Fichier: .github/workflows/deploy-staging.yml
# ==========================================

name: ğŸ§ª Deploy Staging

on:
  push:
    branches: [ develop ]
  workflow_dispatch:

jobs:
  deploy-staging:
    name: ğŸš€ DÃ©ploiement Staging
    runs-on: ubuntu-latest

    environment:
      name: staging
      url: http://staging.localhost:8080

    steps:
      - name: ğŸ“¥ RÃ©cupÃ©rer le code
        uses: actions/checkout@v3

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # Build simple des services
      - name: ğŸ—ï¸ Build Services pour Staging
        run: |
          echo "ğŸš€ Build des services pour staging..."
          
          for service in auth-service project-service file-service notification-service; do
            echo "Build ${service}..."
            cd ${service}
            mvn clean package -DskipTests=true -q
            cd ..
          done
          
          echo "âœ… Services buildÃ©s pour staging!"

      # DÃ©marrage des services d'infrastructure avec Docker
      - name: ğŸ³ DÃ©marrage Infrastructure
        run: |
          echo "ğŸ³ DÃ©marrage de l'infrastructure..."
          
          # PostgreSQL
          docker run -d \
            --name postgres-staging \
            -e POSTGRES_DB=saas_project_db_dev \
            -e POSTGRES_USER=postgres \
            -e POSTGRES_PASSWORD=postgres123 \
            -p 5432:5432 \
            postgres:15-alpine
          
          # Redis  
          docker run -d \
            --name redis-staging \
            -p 6379:6379 \
            redis:7-alpine redis-server --requirepass redis123
          
          echo "âœ… Infrastructure dÃ©marrÃ©e!"

      # Attendre que l'infrastructure soit prÃªte
      - name: â³ Attente Infrastructure
        run: |
          echo "â³ Attente que l'infrastructure soit prÃªte..."
          
          # Attendre PostgreSQL
          for i in {1..30}; do
            if docker exec postgres-staging pg_isready -U postgres > /dev/null 2>&1; then
              echo "âœ… PostgreSQL prÃªt"
              break
            fi
            echo "â³ PostgreSQL pas encore prÃªt (${i}/30)..."
            sleep 2
          done
          
          # Attendre Redis
          for i in {1..30}; do
            if docker exec redis-staging redis-cli -a redis123 ping > /dev/null 2>&1; then
              echo "âœ… Redis prÃªt"
              break  
            fi
            echo "â³ Redis pas encore prÃªt (${i}/30)..."
            sleep 2
          done
          
          echo "âœ… Infrastructure opÃ©rationnelle!"

      # Tests de santÃ© basiques
      - name: ğŸ¥ Tests de SantÃ©
        run: |
          echo "ğŸ” Tests de santÃ© de l'infrastructure..."
          
          # Test PostgreSQL
          docker exec postgres-staging psql -U postgres -d saas_project_db_dev -c "SELECT version();" || echo "âš ï¸ PostgreSQL test Ã©chouÃ©"
          
          # Test Redis
          docker exec redis-staging redis-cli -a redis123 set test "staging-ok" || echo "âš ï¸ Redis test Ã©chouÃ©"
          docker exec redis-staging redis-cli -a redis123 get test || echo "âš ï¸ Redis lecture Ã©chouÃ©e"
          
          echo "âœ… Tests de santÃ© terminÃ©s!"

      # Information de dÃ©ploiement
      - name: ğŸ‰ DÃ©ploiement Staging RÃ©ussi
        run: |
          echo "ğŸ‰ DÃ‰PLOIEMENT STAGING RÃ‰USSI !"
          echo ""
          echo "ğŸ—„ï¸ Infrastructure staging active:"
          echo "   â€¢ PostgreSQL: localhost:5432 (user: postgres, db: saas_project_db_dev)"
          echo "   â€¢ Redis: localhost:6379 (password: redis123)"
          echo ""
          echo "ğŸ³ Containers actifs:"
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          echo ""
          echo "âœ… Infrastructure staging prÃªte!"
          echo "ğŸ“ Les microservices sont buildÃ©s et prÃªts Ã  Ãªtre dÃ©ployÃ©s"
          echo "ğŸ‘‰ Validation manuelle possible avant production"

      # Nettoyage (optionnel)
      - name: ğŸ§¹ Nettoyage (Optionnel)
        if: always()
        run: |
          echo "ğŸ§¹ Nettoyage des containers de test..."
          docker stop postgres-staging redis-staging || true
          docker rm postgres-staging redis-staging || true
          echo "âœ… Nettoyage terminÃ©"