# ==========================================
# SaaS CI - Version Simple (basÃ©e sur cinÃ©ma)
# Fichier: .github/workflows/ci.yml
# ==========================================

name: SaaS CI - Build Simple

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # =================== JOB UNIQUE: BUILD SIMPLE ===================
  build-compile:
    runs-on: ubuntu-latest

    steps:
      # Ã‰tape 1: RÃ©cupÃ©rer le code
      - name: ðŸ“¥ RÃ©cupÃ©rer le code
        uses: actions/checkout@v3

      # Ã‰tape 2: Installer Java 17
      - name: â˜• Installer Java 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # Ã‰tape 3: Cache Maven
      - name: ðŸ“¦ Cache Maven
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}

      # Ã‰tape 4: Build chaque service UN PAR UN
      - name: ðŸ”¨ Build Auth Service
        run: |
          echo "ðŸš€ Build du Auth Service..."
          cd auth-service
          mvn clean compile
          mvn test -DskipTests=false
          echo "âœ… Auth Service compilÃ© et testÃ©!"

      - name: ðŸ”¨ Build Project Service
        run: |
          echo "ðŸš€ Build du Project Service..."
          cd project-service
          mvn clean compile  
          mvn test -DskipTests=false
          echo "âœ… Project Service compilÃ© et testÃ©!"

      - name: ðŸ”¨ Build File Service
        run: |
          echo "ðŸš€ Build du File Service..."
          cd file-service
          mvn clean compile
          mvn test -DskipTests=false
          echo "âœ… File Service compilÃ© et testÃ©!"

      - name: ðŸ”¨ Build Notification Service
        run: |
          echo "ðŸš€ Build du Notification Service..."
          cd notification-service
          mvn clean compile
          mvn test -DskipTests=false
          echo "âœ… Notification Service compilÃ© et testÃ©!"

      - name: ðŸ”¨ Build Analytics Service
        run: |
          echo "ðŸš€ Build du Analytics Service..."
          cd analytics-service
          mvn clean compile
          mvn test -DskipTests=false
          echo "âœ… Analytics Service compilÃ© et testÃ©!"

      # Ã‰tape 5: Message de fin
      - name: ðŸŽ‰ Build terminÃ©
        run: |
          echo "ðŸŽ‰ Tous les services SaaS ont Ã©tÃ© compilÃ©s avec succÃ¨s!"
          echo "ðŸš€ Ton architecture microservices SaaS est prÃªte!"

      # =================== Ã‰TAPE 2: BUILD DOCKER IMAGES ===================
      - name: ðŸ³ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ—ï¸ Build Docker Auth Service
        run: |
          echo "ðŸ³ Build Docker Auth Service..."
          cd auth-service
          if [ ! -f Dockerfile ]; then
            echo "CrÃ©ation Dockerfile basique..."
            cat > Dockerfile << 'EOF'
          FROM openjdk:17-jre-slim
          WORKDIR /app  
          COPY target/*.jar app.jar
          EXPOSE 8081
          ENTRYPOINT ["java", "-jar", "app.jar"]
          EOF
          fi
          mvn clean package -DskipTests=true
          docker build -t saas-auth-service:latest .
          echo "âœ… Docker Auth Service crÃ©Ã©!"

      - name: ðŸ—ï¸ Build Docker Project Service
        run: |
          echo "ðŸ³ Build Docker Project Service..."
          cd project-service
          if [ ! -f Dockerfile ]; then
            echo "CrÃ©ation Dockerfile basique..."
            cat > Dockerfile << 'EOF'
          FROM openjdk:17-jre-slim
          WORKDIR /app
          COPY target/*.jar app.jar  
          EXPOSE 8082
          ENTRYPOINT ["java", "-jar", "app.jar"]
          EOF
          fi
          mvn clean package -DskipTests=true
          docker build -t saas-project-service:latest .
          echo "âœ… Docker Project Service crÃ©Ã©!"

      - name: ðŸ—ï¸ Build Docker File Service
        run: |
          echo "ðŸ³ Build Docker File Service..."
          cd file-service
          if [ ! -f Dockerfile ]; then
            echo "CrÃ©ation Dockerfile basique..."  
            cat > Dockerfile << 'EOF'
          FROM openjdk:17-jre-slim
          WORKDIR /app
          COPY target/*.jar app.jar
          EXPOSE 8083  
          ENTRYPOINT ["java", "-jar", "app.jar"]
          EOF
          fi
          mvn clean package -DskipTests=true
          docker build -t saas-file-service:latest .
          echo "âœ… Docker File Service crÃ©Ã©!"

      - name: ðŸ—ï¸ Build Docker Notification Service
        run: |
          echo "ðŸ³ Build Docker Notification Service..."
          cd notification-service  
          if [ ! -f Dockerfile ]; then
            echo "CrÃ©ation Dockerfile basique..."
            cat > Dockerfile << 'EOF'
          FROM openjdk:17-jre-slim
          WORKDIR /app
          COPY target/*.jar app.jar
          EXPOSE 8084
          ENTRYPOINT ["java", "-jar", "app.jar"] 
          EOF
          fi
          mvn clean package -DskipTests=true
          docker build -t saas-notification-service:latest .
          echo "âœ… Docker Notification Service crÃ©Ã©!"

      # =================== Ã‰TAPE 3: SCAN SÃ‰CURITÃ‰ ===================
      - name: ðŸ”’ Scan SÃ©curitÃ© Basique
        run: |
          echo "ðŸ” Scan de sÃ©curitÃ© des fichiers..."
          
          # Recherche fichiers sensibles
          echo "Recherche de fichiers sensibles..."
          find . -name "*.key" -o -name "*.pem" -o -name "*password*" -o -name ".env" -not -path "./.git/*" | head -10 || echo "Aucun fichier sensible dÃ©tectÃ©"
          
          # VÃ©rification des ports exposÃ©s
          echo "VÃ©rification des ports dans les Dockerfiles..."
          grep -r "EXPOSE" . --include="Dockerfile*" || echo "Ports Docker vÃ©rifiÃ©s"
          
          # VÃ©rification secrets en dur  
          echo "Recherche de secrets potentiels..."
          grep -r -i "password\|secret\|key" . --include="*.yml" --include="*.properties" | grep -v "placeholder\|example\|template" | head -5 || echo "Pas de secrets hardcodÃ©s dÃ©tectÃ©s"
          
          echo "âœ… Scan sÃ©curitÃ© basique terminÃ©!"

      # =================== MESSAGE FINAL ===================
      - name: ðŸŽ‰ Pipeline CI Complet
        run: |
          echo "ðŸš€ PIPELINE CI SAAS COMPLET RÃ‰USSI !"
          echo "âœ… Compilation des 5 services"
          echo "âœ… Tests unitaires"  
          echo "âœ… Build Docker des images"
          echo "âœ… Scan sÃ©curitÃ© basique"
          echo "ðŸ‘‰ PrÃªt pour dÃ©ploiement staging/production !"